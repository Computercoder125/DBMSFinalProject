<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tutors List - AnyTimeTutoring</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
      }

      header {
        background-color: #333;
        color: white;
        padding: 10px 0;
        text-align: center;
      }

      nav {
        background-color: #444;
        display: flex;
        justify-content: center;
        padding: 10px;
      }

      nav a {
        color: white;
        text-decoration: none;
        padding: 10px 15px;
        margin: 0 10px;
        font-size: 16px;
      }

      nav a:hover {
        background-color: #575757;
        border-radius: 5px;
      }

      main {
        text-align: center;
      }

      .tutors-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        padding: 20px;
      }

      .tutor-box {
        background-color: #f1f1f1;
        border: 1px solid #ccc;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: left;
        border-radius: 8px;
      }

      .tutor-box h3 {
        margin-top: 0;
      }

      .tutor-box p {
        margin: 5px 0;
      }

      .tutor-box button {
        background-color: #4caf50;
        color: white;
        padding: 8px 12px;
        border: none;
        cursor: pointer;
        border-radius: 5px;
      }

      .tutor-box button:hover {
        background-color: #45a049;
      }

      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 1em 2em;
        border-radius: 4px;
        position: relative;
        text-align: center;
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        color: red;
        font-size: 1.5em;
        cursor: pointer;
      }

      img {
        width: 100%;
        height: auto;
        max-height: 70vh;
        object-fit: cover;
        margin-top: 20px;
      }

      .search-bar {
        margin: 20px;
        padding: 10px;
        font-size: 16px;
        width: 50%;
        border-radius: 5px;
        border: 1px solid #ccc;
      }

      .dummy-text {
        margin-top: 40px;
        font-size: 16px;
        color: #333;
      }
    </style>
  </head>
  <body>
    <header>
      <h2>Tutor List</h2>
    </header>

    <nav>
      <a href="http://localhost:3000/main">Home</a>
      <a href="http://localhost:3000/tutors-page">View Tutors</a>
      <a href="http://localhost:3000/view">View Appointments</a>
      <a href="http://localhost:3000/contacts">Contacts</a>
      <a href="http://localhost:3000/logout">Log Out</a>
    </nav>

    <main>
      <!-- Search Bar -->
      <input
        type="text"
        id="subject-search"
        class="search-bar"
        placeholder="Search tutors by subject..."
        oninput="filterTutors()"
      />

      <div id="tutors-container" class="tutors-container"></div>
    </main>

    <!-- Popup Modal -->
    <div id="popup-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2>Book Tutor</h2>
        <p id="selected-tutor-details">Loading...</p>
        <button onclick="confirmBooking()">Confirm Booking</button>
      </div>
    </div>

    <script>
      let selectedTutorId = null;
      let currentAccountId = 1; // Example: You would normally get this from the logged-in user's session
      let tutorsData = []; // This will hold the tutor data for filtering

      // Fetch data from the tutors table
      fetch("http://localhost:3000/tutors")
        .then((response) => response.json())
        .then((data) => {
          tutorsData = data.tutors;
          displayTutors(tutorsData); // Display all tutors initially
        })
        .catch((error) => {
          console.error("Error fetching tutors:", error);
          document.getElementById("tutors-container").innerHTML =
            "<p>Error fetching tutors data.</p>";
        });

      // Function to display the tutors
      function displayTutors(tutors) {
        const tutorsContainer = document.getElementById("tutors-container");

        // Check if there are tutors to display
        if (tutors && tutors.length > 0) {
          tutorsContainer.innerHTML = ""; // Clear previous tutors
          tutors.forEach((tutor) => {
            const tutorBox = document.createElement("div");
            tutorBox.classList.add("tutor-box");

            tutorBox.innerHTML = `
              <h3>${tutor.name}</h3>
              <p><strong>Email:</strong> ${tutor.email}</p>
              <p><strong>Subject Specialization:</strong> ${
                tutor.subject_specialization
              }</p>
              <p><strong>Availability:</strong> ${
                tutor.availability || "Not specified"
              }</p>
              <p><strong>Signup Date:</strong> ${tutor.signup_date}</p>
              <p><strong>Status:</strong> ${tutor.status}</p>
              <button onclick="showModal(${tutor.tutor_id}, '${tutor.name}', '${
              tutor.email
            }')">Book Tutor</button>
            `;
            tutorsContainer.appendChild(tutorBox);
          });
        } else {
          tutorsContainer.innerHTML = "<p>No tutors available.</p>";
        }
      }

      // Filter tutors based on subject specialization
      function filterTutors() {
        const searchQuery = document
          .getElementById("subject-search")
          .value.toLowerCase();
        const filteredTutors = tutorsData.filter((tutor) =>
          tutor.subject_specialization.toLowerCase().includes(searchQuery)
        );
        displayTutors(filteredTutors);
      }

      // Show the modal with tutor details
      function showModal(tutorId, tutorName, tutorEmail) {
        selectedTutorId = tutorId; // Store the selected tutor's ID
        const modal = document.getElementById("popup-modal");
        const tutorDetails = document.getElementById("selected-tutor-details");
        tutorDetails.textContent = `Tutor ID: ${tutorId}, Name: ${tutorName}, Email: ${tutorEmail}`;
        modal.classList.add("active");
      }

      // Close the modal
      function closeModal() {
        const modal = document.getElementById("popup-modal");
        modal.classList.remove("active");
      }

      // Function to confirm booking
      function confirmBooking() {
        if (!selectedTutorId) {
          alert("Please select a tutor to book.");
          return;
        }

        // Send the data to the backend using fetch
        fetch("http://localhost:3000/view", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            account_id: currentAccountId,
            tutor_id: selectedTutorId,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            alert("Booking successful!");
            closeModal();
          })
          .catch((error) => {
            console.error("Error booking appointment:", error);
            alert("Error booking appointment.");
          });
      }
    </script>
  </body>
</html>
